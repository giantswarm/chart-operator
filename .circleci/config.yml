version: 2.1
orbs:
  architect: giantswarm/architect@4.34.1
  architect-test:
    commands:
      image-prepare-tag:
        parameters:
          tag-suffix:
            type: "string"
            default: ""
        steps:
          - run:
              name: Generate container tag from 'architect project version' and tag-suffix parameter
              command: |
                echo -n "$(architect project version)<<parameters.tag-suffix>>" | tee .docker_image_tag
      image-build-with-docker:
        parameters:
          build-context:
            type: "string"
            default: "."
          dockerfile:
            type: "string"
            default: "./Dockerfile"
        steps:
          - run:
              name: Build the container image using 'docker build'
              command: |
                docker build -f "<<parameters.dockerfile>>" "<<parameters.build-context>>" --progress plain 2>&1 | tee .docker.log
          - run:
              name: Save container image SHA256 to temp file
              command: |
                awk -F" " '/^#[0-9]+ writing image sha256:[0-9a-f]{40}/ {print $4}' .docker.log | tee .image_sha256
          - run:
              name: Print image SHA256
              command: |
                cat .image_sha256
      image-push-to-registry:
        parameters:
          image_sha256:
            type: "string"
          registry:
            type: string
          image:
            type: "string"
          tag:
            type: "string"
          password_envar:
            type: "env_var_name"
          username_envar:
            type: "env_var_name"
          tag-latest-branch:
            type: "string"
          tag-suffix:
            type: "string"
            default: ""
          build-context:
            type: "string"
            default: "."
          dockerfile:
            type: "string"
            default: "./Dockerfile"
        steps:
          - run:
              name: Authenticate to the container registry
              command: |
                echo -n "${<<parameters.password_envar>>}" | docker login --username "${<<parameters.username_envar>>}" --password-stdin "<<parameters.registry>>"
          - run:
              name: Tag the image
              command: |
                docker tag <<parameters.image_sha256>> "<<parameters.registry>>/<<parameters.image>>:<<parameters.tag>>"
          - run:
              name: Print image push info
              command: echo "Pushing image with SHA256 <<parameters.image_sha256>> as <<parameters.registry>>/<<parameters.image>>:<<parameters.tag>>"
          - run:
              name: Push the container image using 'docker push'
              command: |
                docker push "<<parameters.registry>>/<<parameters.image>>:<<parameters.tag>>" || docker push "<<parameters.registry>>/<<parameters.image>>:<<parameters.tag>>" || docker push "<<parameters.registry>>/<<parameters.image>>:<<parameters.tag>>"
          - when:
              condition:
                equal: [<<parameters.tag-latest-branch>>, "${CIRCLE_BRANCH}"]
              steps:
                - run:
                    name: "When parameter 'tag-latest-branch' matches this branch: Retag the image as 'latest'"
                    command: |
                      docker tag <<parameters.image_sha256>> "<<parameters.registry>>/<<parameters.image>>:latest"
                - run:
                    name: "When parameter 'tag-latest-branch' matches this branch: Push the 'latest' image to the container registry"
                    command: |
                      docker push "<<parameters.image>>:latest<<parameters.tag-suffix>>"
    jobs:
      push-to-registries:
        parameters:
          image:
            description: 'Name of the  container repository and image, without tag. e.g. "my-org/my-image".'
            type: "string"
          tag-latest-branch:
            description: 'Name of the branch on which the image will be additionally tagged as "latest".'
            type: "string"
            default: "main"
          resource_class:
            default: "small"
            description: |
              Configures the amount of CPU and RAM for the job. See
              https://circleci.com/docs/2.0/configuration-reference/#docker-executor
              for details.
            type: "enum"
            enum: ["small", "medium", "medium+", "large", "xlarge"]
          build-context:
            type: "string"
            default: "."
          dockerfile:
            type: "string"
            default: "./Dockerfile"
          tag-suffix:
            type: "string"
            default: ""
        executor: "architect"
        resource_class: "<< parameters.resource_class >>"
        steps:
          - checkout
          - setup_remote_docker:
              version: default
          - attach_workspace:
              at: .
          - image-prepare-tag:
              tag-suffix: <<parameters.tag-suffix>>
          - image-build-with-docker:
              build-context: <<parameters.build-context>>
              dockerfile: <<parameters.dockerfile>>
          - image-push-to-registry:
              image_sha256: $(cat .image_sha256)
              registry: quay.io
              image: <<parameters.image>>
              tag: $(cat .docker_image_tag)
              username_envar: QUAY_USERNAME
              password_envar: QUAY_PASSWORD
              build-context: <<parameters.build-context>>
              dockerfile: <<parameters.dockerfile>>
              tag-latest-branch: <<parameters.tag-latest-branch>>
              tag-suffix: <<parameters.tag-suffix>>
          #- image-push-to-registry:
          #    image_sha256: $(cat .image_sha256)
          #    registry: giantswarm-registry.cn-shanghai.cr.aliyuncs.com
          #    image: <<parameters.image>>
          #    tag: $(cat .docker_image_tag)
          #    username_envar: ALIYUN_USERNAME
          #    password_envar: ALIYUN_PASSWORD
          #    build-context: <<parameters.build-context>>
          #    dockerfile: <<parameters.dockerfile>>
          #    tag-latest-branch: <<parameters.tag-latest-branch>>
          #    tag-suffix: <<parameters.tag-suffix>>
        environment:
          DOCKER_BUILDKIT: "1"
    executors:
      architect:
        docker:
          - entrypoint: /bin/bash
            image: quay.io/giantswarm/architect:6.12.1

workflows:
  build:
    jobs:
      - architect-test/push-to-registries:
          context: "architect"
          name: push-chart-operator-to-registries
          image: "giantswarm/chart-operator"
          # Needed to trigger job also on git tag.
          filters:
            tags:
              only: /^v.*/
